<?php
/**
 * Copyright Â© 2017 Magestore. All rights reserved.
 * See COPYING.txt for license details.
 */

/**
 * Magestore
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magestore.com license that is
 * available through the world-wide-web at this URL:
 * http://www.magestore.com/license-agreement.html
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 */

// @codingStandardsIgnoreFile

?>
<?php /* @var $block \Magestore\Giftvoucher\Block\Adminhtml\Product\View */ ?>
<?php
$store = $block->getObjectManager()->get('Magento\Backend\Model\Session\Quote')->getStore();
$_product = $block->getProduct();
$_giftAmount = $block->getGiftAmount($_product);
$timezones = $block->getTimeZones();
$timezone = $this->getStoreManager()->getStore()->getConfig('general/locale/timezone');
$rateTax = $block->getTaxRate();
?>
<?php //echo $block->getLayout()->createBlock('Magento\Framework\View\Element\Html\Calendar')->setTemplate('Magento_Backend::page/js/calendar.phtml')->toHtml();  ?>
<fieldset id="catalog_product_composite_configure_fields_giftvoucher"
          class="fieldset admin__fieldset composite-giftvoucher<?php echo $block->getIsLastFieldset() ? ' last-fieldset' : '' ?>">
    <label class="legend admin__legend"><span><?php echo __('Gift Card Products') ?></span></label>
    <div class="product-options">
        <?php if ($_giftAmount['type'] == 'range'): ?>
            <div class="field admin__field">
                <label class="label admin__field-label"><?php echo 'Enter value' ?></label>
            </div>
            <div class="control admin__field-control">
                <input id="amount_range" name="amount" class="required-entry validate-greater-than-zero admin__control-text"
                       style="width: 180px"
                       onchange="giftCard.validateInputRange(this, <?php echo $_giftAmount['from'] ?>, <?php echo $_giftAmount['to'] ?>, '<?php echo $store->getCurrentCurrency()->format(1000, array(), false); ?>');"
                       value="<?php echo $block->getOptionProduct('amount'); ?>"/>
                (<span class="price" style="clear:both"><?php echo $_giftAmount['from_txt'] ?></span> - <span
                        class="price"><?php echo $_giftAmount['to_txt'] ?></span>)
            </div>
        <?php elseif ($_giftAmount['type'] == 'dropdown'): ?>
            <div class="field admin__field">
                <label class="label admin__field-label"><?php echo 'Select value' ?></label>
                <div class="control admin__field-control">
                    <select id="amount_dropdown" name="amount" class="required-entry admin__control-select"
                            onchange="giftCard.setAmountDropDown(this)">
                        <?php $options = array_combine($_giftAmount['options'], $_giftAmount['options_txt']) ?>
                        <?php foreach ($options as $value => $label): ?>
                            <option
                                    value="<?php echo $value ?>" <?php if ($value == $block->getOptionProduct('amount')) echo 'selected' ?> ><?php echo $label ?></option>
                        <?php endforeach ?>
                    </select>
                    <input id="abc" type="hidden" value="1" price="<?php echo $_giftAmount['options'][0] ?>"
                           qtyid="product_composite_configure_input_qty">
                </div>
            </div>
        <?php elseif ($_giftAmount['type'] == 'static'): ?>
            <div class="field admin__field">
                <label
                        class="label admin__field-label"><?php echo __('Gift Card value: <span class="regular-price">%1</span>', $_giftAmount['value_txt']) ?></label>
                <div class="control admin__field-control">
                    <input type="hidden" name="amount" value="<?php echo $_giftAmount['value'] ?>"/>
                </div>
            </div>
        <?php endif; ?>
        <?php $templates = $block->getAvailableTemplateAdmin(); ?>
        <?php if (($_product->getData('gift_card_type') != \Magestore\Giftvoucher\Model\Source\GiftCardTypeOptions::TYPE_PHYSICAL)): ?>
            <?php if (count($templates)
        ): ?>
            <script type="text/javascript">
                templates = <?php echo $block->getJsonEncode()->encode($templates); ?>;
            </script>
            <div class="field admin__field">
                <label class="label admin__field-label"><?php echo __('Select a template ') ?></label>
                <div class="control admin__field-control">
                    <select
                            class="admin__control-select"
                            id="giftcard_template_select" name="giftcard_template_id" onchange="giftCard.changeTemplate(this)">
                        <?php foreach ($templates as $template): ?>
                            <option value="<?php echo $template['giftcard_template_id'] ?>" <?php if ($block->getOptionProduct('giftcard_template_id') == $template['giftcard_template_id']) echo 'selected' ?>><?php echo $template['template_name'] ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="control admin__field-control">
                    <input type="hidden" name="giftcard_template_image" id="giftcard-template-images"
                           value="<?php echo $block->getOptionProduct('giftcard_template_image') ? $block->getOptionProduct('giftcard_template_image') : '0' ?>"/>
                    <div id="giftcard-template-show-images"
                         style="position: relative;height: 62px; width: 311px;padding-left: 15px; margin-top: 10px">
                        <div id="giftcard-template-prev"
                             style="filter:alpha(opacity=30);opacity: 0.3;z-index: 10;position: absolute;cursor: pointer; left: 0; top: 0; width: 20px; height: 62px;"
                             onclick="giftCard.giftcardPrevImage();"></div>
                        <?php foreach ($templates as $template): ?>
                            <div id="image-for-<?php echo $template['giftcard_template_id'] ?>"
                                 style="/*display:none*/">
                                <?php
                                $count = 0;
                                if (!$template['images'])
                                    $template['images'] = 'default.png'; //07.01
                                if ($template['images']) {
                                    $images = explode(',', $template['images']);
                                    $maxCount = count($images) - 1;
                                    foreach ($images as $image) {
                                        if ($count % 4 == 0) {
                                            echo '<div id="div-bound-' . $template['giftcard_template_id'] . '-' . $count . '" style="display:none">';
                                        }
                                        $url = $block->getGiftvoucherHelper()->getStoreManager()->getStore()->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA) . 'giftvoucher/template/images/'  . $image;
                                        echo '<div id="div-image-for-' . $template['giftcard_template_id'] . '-' . $count . '" style="position:relative; float: left;border: 2px solid white; width: 70px; height: 52px; text-align: center;cursor: pointer;" onclick="giftCard.changeSelectImages(' . $count . ')">';
                                        echo '<img id="image-for-' . $template['giftcard_template_id'] . '-' . $count . '" src="' . $url . '" width=68 height=50 alt="image giftcard" style="border: 1px solid white; margin-top: 0">';
                                        echo '<div class="egcSwatch-arrow" style="display:none"></div>';
                                        echo '</div>';
                                        if ($image == $block->getOptionProduct('giftcard_template_image') && $block->getOptionProduct('giftcard_template_id') == $template['giftcard_template_id']) {
                                            echo '<script type="text/javascript">$("div-bound-' . $template['giftcard_template_id'] . '-' . ($count - $count % 4) . '").show(); giftcard_prev = ' . ($count - $count % 4) . '; giftcard_next = ' . ($count - $count % 4 + 4) . '; image_form_data = ' . $count . ';</script>';
                                        }
                                        $count += 1;
                                        if ($count % 4 == 0 || $count > $maxCount) {
                                            echo '</div>';
                                        }
                                    }
                                }
                                ?>
                            </div>
                        <?php endforeach; ?>
                        <div id="giftcard-template-next"
                             style="filter:alpha(opacity=30);opacity: 0.3;z-index: 10;cursor: pointer;position: absolute; right: 0; top: 0; width: 20px; height: 62px;"
                             onclick="giftCard.giftcardNextImage();"></div>
                    </div>

                </div>
            </div>
        <?php endif; ?>
        <?php else: ?>
            <div class="field admin__field">
                <label class="label admin__field-label"><?php echo __('Custom message') ?></label>
                <div class="control admin__field-control">
                    <textarea style="width: 500px;height: 50px" name="message" id="message"  class="admin__control-textarea"
                              onchange="giftCard.changeRemaining(this, '<?php echo $block->messageMaxLen() ?>');"
                              onkeyup="giftCard.changeRemaining(this, '<?php echo $block->messageMaxLen() ?>');">
                        <?php echo $block->getOptionProduct('message') ?>
                    </textarea>
                    <p>
                        <small><?php echo __('Characters Remaining: ') ?>
                            <span id="giftvoucher_char_remaining"><?php echo $block->messageMaxLen() ?></span>
                        </small>
                    </p>
                </div>
            </div>
        <?php  endif; ?>
        <?php if ($block->enablePhysicalMail() && ($_product->getData('gift_card_type') != 1)): ?>
            <div class="field admin__field">
                <input type="checkbox" value="<?php echo __('Yes') ?>" name="recipient_ship" id="recipient_ship"
                       onclick="giftCard.shipToFriend(this, '<?php echo !$block->getGiftvoucherHelper()->getEmailConfig('send_with_ship') ? true : false; ?>');" <?php if ($block->getOptionProduct('recipient_ship')) echo 'checked' ?> />
                <label for="recipient_ship"><?php echo __('Send through post office') ?></label>
            </div>
        <?php endif; ?>
        <?php if ($_product->getData('gift_card_type') != \Magestore\Giftvoucher\Model\Source\GiftCardTypeOptions::TYPE_PHYSICAL) :?>
            <div class="field admin__field">
                <input type="checkbox" value="1" name="send_friend" id="send_friend"
                       onclick="giftCard.sendFriend(this);" <?php if ($block->getOptionProduct('send_friend')) echo 'checked' ?> />
                <label for="send_friend"><?php echo __('Send Gift Card to friend') ?></label>
            </div>
        <?php endif; ?>
    </div>
    <div class="product-options giftvoucher-receiver" id="giftvoucher-receiver"
         style="<?php if (!$block->getOptionProduct('send_friend')) echo 'display:none;' ?>">
        <div class="field admin__field">
            <label class="label admin__field-label"><?php echo __('Sender name (optional):') ?></label>
            <div class="control admin__field-control">
                <input type="text" name="customer_name" id="customer_name"  class="admin__control-text"
                       style="width: 400px"
                       value="<?php echo $block->getOptionProduct('customer_name') ?>" maxlength="12"/>
            </div>
        </div>
        <div class="field admin__field">
            <label class="label admin__field-label"><?php echo __('Recipient name: ') ?><span
                        style="color:red"> * </span></label>
            <div class="control admin__field-control">
                <input type="text" name="recipient_name" id="recipient_name"  class="admin__control-text"
                       style="width: 400px"
                       value="<?php echo $block->getOptionProduct('recipient_name') ?>" maxlength="12"/>
            </div>
        </div>
        <div class="field admin__field">
            <label class="label admin__field-label"><?php echo __('Recipient email address: ') ?><span
                        style="color:red"> * </span></label>
            <div class="control admin__field-control">
                <input type="text" name="recipient_email" id="recipient_email"  class="admin__control-text"
                       style="width: 400px"
                       value="<?php echo $block->getOptionProduct('recipient_email') ?>"/>
            </div>
        </div>
        <script type="text/javascript">
            //<![CDATA[
            var remaining_max = '<?php echo $block->messageMaxLen() ?>';
            //]]>
        </script>
        <p id="recipient_ship_desc" style="display:none;"><?php echo $block->getRecipientShipDesc();?></p>
        <div class="field admin__field">
            <label class="label admin__field-label"><?php echo __('Custom message') ?></label>
            <div class="control admin__field-control">
                <textarea style="width: 500px;height: 50px" name="message" id="message" class="admin__control-textarea"
                          onchange="giftCard.changeRemaining(this, '<?php echo $block->messageMaxLen() ?>');"
                          onkeyup="giftCard.changeRemaining(this, '<?php echo $block->messageMaxLen() ?>');"><?php echo $block->getOptionProduct('message') ?></textarea>
                <p>
                    <small><?php echo __('Characters Remaining: ') ?><span
                                id="giftvoucher_char_remaining"><?php echo $block->messageMaxLen() ?></span></small>
                </p>
            </div>
        </div>
        <div class="field admin__field">
            <input type="checkbox" value="1" name="notify_success"
                   id="notify_success" <?php if ($block->getOptionProduct('notify_success')) echo 'checked' ?> />
            <label
                    class="label admin__field-label"><?php echo __('Send-to-purchaser email when recipient receives Gift Card') ?></label>
        </div>
        <?php if ($block->enableScheduleSend()): ?>
            <div class="field admin__field" style="height: 100%">
                <label class="label admin__field-label"><?php echo __('Day to send') ?></label>
                <div class="control admin__field-control">
                    <input type="text" name="day_to_send" id="day_to_send"
                           class="admin__control-select"
                           value="<?php echo $block->getOptionProduct('day_to_send') ?>"
                           style="float: left; margin-right: 3px"/>
                </div>
            </div>
            <div class="field admin__field"  style="clear: both">
                <label class="label admin__field-label"><?php echo __('Time Zone') ?></label>
                <div class="control admin__field-control">
                    <select class="required-entry admin__control-select" name="timezone_to_send" id="timezone_to_send">
                        <?php
                        foreach ($timezones as $timezone) {
                            ?>
                            <option value="<?php echo $timezone['value']; ?>" <?php if ($this->getStoreManager()->getStore()->getConfig('general/locale/timezone') == $timezone['value']) echo 'selected' ?> ><?php echo $timezone['label']; ?></option>
                            <?php
                        }
                        ?>
                    </select>
                </div>
            </div>
        <?php endif; ?>
    </div>
</fieldset>
<script>
    require([
        "jquery",
        "mage/calendar",
        "prototype",
        "Magestore_Giftvoucher/js/add-product"
    ], function ($) {
        $("#day_to_send").calendar({
            dateFormat: "mm/dd/yy",
            minDate: new Date(),
            showOn: "button",
            showAnim: "",
            changeMonth: true,
            changeYear: true,
            buttonImageOnly: null,
            buttonImage: null,
            showButtonPanel: true,
            showWeek: true,
            timeFormat: '',
            showTime: false,
            showHour: false,
            showMinute: false
        });
        window.giftCard.initialize();
        window.giftCard.changeTemplate($('giftcard_template_select'));
    });
</script>
<style>
    select.mage-error, input.mage-error {
        border: 1px solid #e22626 !important;
    }
    .gift-active {
        border: 1px solid red !important;
    }
</style>